{
  "Name": "ecl-build",
  "Vars": {
    "build_date": "${TIMESTAMP}",
    "publish_project": "${PROJECT}"
  },
  "Sources": {
    "build.sh": "./build.sh"
  },
  "Steps": {
    "setup-disks": {
      "CreateDisks": [
        {
          "Name": "disk-build",
          "SourceImage": "projects/debian-cloud/global/images/family/debian-11",
          "SizeGb": "200",
          "Type": "pd-ssd"
        },
        {
          "Name": "disk-install",
          "SizeGb": "1",
          "Type": "pd-ssd"
        }
      ]
    },
    "run-build": {
      "CreateInstances": [
        {
          "Name": "inst-build",
          "Disks": [
            {
              "Source": "disk-build"
            },
            {
              "Source": "disk-install"
            }
          ],
          "MachineType": "n1-highcpu-8",
          "StartupScript": "build.sh"
        }
      ]
    },
    "wait-for-build": {
      "Timeout": "20m",
      "WaitForInstancesSignal": [
        {
          "Name": "inst-build",
          "SerialOutput": {
            "Port": 1,
            "StatusMatch": "AgileOS build status:",
            "FailureMatch": "Finished running startup scripts.",
            "SuccessMatch": "AgileOS build finished"
          }
        }
      ]
    },
    "del-build": {
      "DeleteResources": {
        "Instances": [
          "inst-build"
        ]
      }
    },
    "create-image": {
      "CreateImages": [
        {
          "Name": "agile-os-v${build_date}",
          "SourceDisk": "disk-install",
          "GuestOsFeatures": [
            "VIRTIO_SCSI_MULTIQUEUE",
            "UEFI_COMPATIBLE",
            "MULTI_IP_SUBNET"
          ],
          "Family": "agile-os",
          "Project": "${publish_project}",
          "NoCleanup": true,
          "ExactName": true
        }
      ]
    }
  },
  "Dependencies": {
    "run-build": [
      "setup-disks"
    ],
    "wait-for-build": [
      "run-build"
    ],
    "del-build": [
      "wait-for-build"
    ],
    "create-image": [
      "del-build"
    ]
  }
}