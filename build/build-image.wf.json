{
  "Name": "ecl-build",
  "Vars": {
    "build_date": "${TIMESTAMP}",
    "publish_project": "${PROJECT}",
    "gcs_root": {
      "Required": true
    },
    "kernel_package": {
      "Required": true
    },
    "packages": {
      "Required": false
    },
    "image_output_bucket": {
      "Required": true
    },
    "pk": "MIIFFTCCAv2gAwIBAgIUF2rKJXFFwOMSxp94S/WE8vcLNh8wDQYJKoZIhvcNAQELBQAwGjEYMBYGA1UEAwwPbXkgUGxhdGZvcm0gS2V5MB4XDTIyMDQyODIwMDc0NloXDTMyMDQyNTIwMDc0NlowGjEYMBYGA1UEAwwPbXkgUGxhdGZvcm0gS2V5MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEApuOZWrPL9TijPR+C9KSh9bX75CJ3JBJG0LUC/HpuDQLGHgwUzDgFJ1FLuEptMFMhRidwypp5BKkX1Yi2F2mzFuYRjf9myD0dnJDJBKdAq204KumISPxitG//DBdnRIZ03yfZArHSA5IcNH549LuVld3UJ4Bxckk5JjTZVmNUfks/sLcAs1etQ7SCKMfh1vFS6Aic4DOk75F0kTu6h9IGvsV+33FdcSts+613IB/ZfL5DGv+P15aq69Mu2weysszcbwuTm/mY1GkClm52QpoIGEVRn3dJrbcszIZRpA1sCXPKMoJFQajjL2+0FdZq40CZl5ZGfnKEdtYFweOZ05ISOUgUJk4dxHcbWwaDCTkZvfjI3s1EvKnBs4O/1Y+1dZQMSJMCqZYq/2aYVyxi8hjn1bCNyUZ28X6ShMGfy8uLu3bbkdP5TaB/70CXiyq1nzA88Nq41DerquytiKK5Pj6V1oaVFpJ1Bh7gC20kN4GMo13U5pPqal73GUWgSF0RvKcKQGHb/xvSSURznjrrC1Ceja/4jqOX1d3nBixzqrQ5B6dk1uBRK4HVUu6fn/zftodFRH2073vjtnL+bMvIrLbRsM6/+Gmp3zD0ymacdkLxyNE/tQEvWtA0x4rke4gWI/0E9auVL2vmxBDPO/bhK0Hyq+/K4lerK9QJ1vbvZy4OtTsCAwEAAaNTMFEwHQYDVR0OBBYEFAGuV3WLuv1gEsLoCdXYhB3+gQZsMB8GA1UdIwQYMBaAFAGuV3WLuv1gEsLoCdXYhB3+gQZsMA8GA1UdEwEB/wQFMAMBAf8wDQYJKoZIhvcNAQELBQADggIBAD04Gi6T22OsBPFwJeyTwVxAvDu5cIOwq5nHuuz7MghcODaaPCAk1T+1dwiT4gO2adnhKbs5sH8FwGieKTSccYRSbcHQh5zjT6/yFoMIERfnxzZwa+9k/DJQ37RKfL7Qxckj4Nr1t6bUHMB4KQzJTtjZSHUX6yvqgn7Y/quSGh96FVdsTqh0NiIJTYVMgGHy1OLqVtI/dXGib4kttFW41Jm75/htQ1zag227Ob2Yu4cTgse99Ai/msUp357CSOdSHLiNPYoaoFJobfuAVnwlBJWxGhgHo4UQGonX3gLn0B3sog675y6eouiTGGKPEpFCwN6/5KLP0xtxCUcnSUopWX+PeVLhAoQI8Kk15El4Pop+y7zemPkZgeLKFzJxxveH+xLCoawel5KYQMMPgOodhYCd1jM+kGPC9DdV/bMRETO5/pKFRAQvePX3ASE7aFXCUu9m/RiDnUcOyvy4+tblGfwyduE8bLZjj8kvKD1WnzzpWNhQmo+7HscDlmHn+a/J1PiTIGLI8/A0BnIQfUQe4F99O/PFPMc/fvl8iEgE9BLUrcknWM7zyY0lxTRnJgtipeL1jxb+28xZ8Bz1Cg0Bvle/wmo+/Nkcsawz00imFjZpj3CFzgj6UktLM0d5jIWM8PM59tCP6PGVr54urdt0SjyP/awv+ul2f4vDUkc3d0Sr",
    "kek": "MIIFHTCCAwWgAwIBAgIUByVsrGDOHoVQcBOlK065kuXIQVowDQYJKoZIhvcNAQELBQAwHjEcMBoGA1UEAwwTbXkgS2V5IEV4Y2hhbmdlIEtleTAeFw0yMjA0MjgyMDMyMTFaFw0zMjA0MjUyMDMyMTFaMB4xHDAaBgNVBAMME215IEtleSBFeGNoYW5nZSBLZXkwggIiMA0GCSqGSIb3DQEBAQUAA4ICDwAwggIKAoICAQCbMQtfSS9rz7vis5GtPBTsGUO5tdwKhYb/DZpztqk68DtUXqBP1danJ/WIRUH2kwIoI90Z0m6O8zOOc1rSjxRWCVC1YSsU34/YiDFHekY6ITPF4AWXztattJtOSqksOEeyYSDNTg4J7gcOVcNfN33SyIOmtRe4lOR8DysA8k16/Hh3wf5r+OBRO8zP48bhhIzC9iE0VIOnHL8uXyxc4DHZGcIaffGBwCx/hwUvMzrd/ESW5nKjPPt+llDpNJtdt3M5o7T2oGVcFLRjygtqObqeuLa/DTXC5+xL5vjSpdHPokfTO9xfgeSdRfIWsR8XsMROxvMn+KUHbQFzGZyzThPJhZ7+TiNmxdrCF7U9wRQMyk6adsnln/oUxzsiWz4tubaM0WQMAVzabN3Q0Is22kvc5eF6JVnLywjmTD4ZREVSkmIqOjDzQkNNB+bcf0mioDzv0ik/D0fBNGAenBK+OZv4sjeBWvcQq/Hz01EfIH1kBQwpmG3mm9HWj4IwgDO58x7XtDcCIDbh9MbgyHSg20Qnkp+M9XkMGkB0pLbp4F3z+0nWc/K7dddUeHUVuqgjYI8hRE6wHnhg7r3AHsKzGXDq9F4vOJtnavkRp/9GQxDJ5ACQCYDh8R40rxFarJ3JFiZ+RSeWBvVPHHfImGudh7m3D58e9D74PnKvKxI1/aIwZwIDAQABo1MwUTAdBgNVHQ4EFgQUX7b9tVhJrleZKPOi3Y0lieeOgsowHwYDVR0jBBgwFoAUX7b9tVhJrleZKPOi3Y0lieeOgsowDwYDVR0TAQH/BAUwAwEB/zANBgkqhkiG9w0BAQsFAAOCAgEAWZr9vFQBvLW+GTazrNt3d0f5QjR7S4PCpNoH2breqHe1mQEAl7JRd2rY2pJmnQDfslq5CO55nuPpZ34J8U6FHMiHJ3n+iNSOlQm15Ljywa0y1KbZ5DaNiZVChYw3V9blK3pM+WG7Xs9CCwSOBsb6F/9gpUPEQxs0KUhA9xxLZuE3GjcPk//w88xjJX/PiltjimtZLuK3toU8rECZfUbvsZMA0w68sWbhxoFeQEyc9eJ2sZWWdPEhKWQ/w2Vz4vxGLEf5lSFHc6TWfTyUCpLiOy1DnC0cut84jX/rl+xTltCV028YZQy9BPIII0h/BSI8gdRjYziE9hwSjiL7YSqXy6oe2kIGlMrEBH5j508ZFnjnSJ0nmZwfXFTuj6OvUI6EtK6xqQofqdrAxISOrTli2XMXL8invBMKOivgPgZGd1rgeaHOTjhsNbupDe0T+gqrZfaP/jTT36Fq9cNtMQqNn1kH9YamFIl2Sa1gVKonzb1zqC/dFRfV5Hl6RDnQij5MpJwwiEpy/iPkEuuYga61H5lpNruIHKUNFbq6ydHr8/guCD0kk8hfsC4QWE9pC5gP1tpm0rhk5ziilhzX1y0bJUMKznfQECC7PpBbYOWn4rKGPdBtBFXffXBodTvFqDwWXHt79fev3lD2gx/4ivLzTzsQPEXidkGJfKi4F9V4Qcw=",
    "db": "MIIFKTCCAxGgAwIBAgIUL+6Z9pPyLQkHO/cczxM+hfQ2qTwwDQYJKoZIhvcNAQELBQAwJDEiMCAGA1UEAwwZbXkgU2lnbmF0dXJlIERhdGFiYXNlIGtleTAeFw0yMjA0MjgyMDEwMzVaFw0zMjA0MjUyMDEwMzVaMCQxIjAgBgNVBAMMGW15IFNpZ25hdHVyZSBEYXRhYmFzZSBrZXkwggIiMA0GCSqGSIb3DQEBAQUAA4ICDwAwggIKAoICAQCUWDFp/mUcIy+wbVPuqwWVeIR+hMahvKVDvV1c07FssjL/olGn6X2poyirH3JiIHasUGJbC62ersLj4oIBwmnolrNRE1Wdoi+cWZZLp7XuAyHALJOSIDtLjoeEZWVPVAAWoWMYTvJRjvnskdJ3E/Ia6jf4X4zR7sAgV5gAgFi7LRYe8klU20qyIsNAJMuvNoqotOqmMOzF1OmTxY+05zLlsc3zgoM7X6boe/bmrts6iaPIXYcZOVX5eu661apuJwYFkiCfwHyiRBQHMkc4X+uOXi4xWde6eY0ZsjX6DNvtvJvLTaXMeoK8cViKe1PyWK6jJ9V9rc5lDJRFxr7xHbP90Bl0Qix42INry32Te4KQGNhC01K0pDPxhqIOf51y+SgeAHdgQtUA0uR6hRNxaHWLT5P2Jcjiu3LDitnanVscFUk8yT1mMkkFG9FmDLWKarH3l1zSILgilyBdLEHzbiqUsUiJCHZOw0isg4WNk89sLF7IG2cn2G4GWLVrcaKc5Yptm4rcfEW6wkPz5Bc2rrwAMEISEK4Tpdax1xW+Flc15n5OCE0EJybkdtg1n1kDwelEV1ZT4aNzMBny3DFdN6sKud0VAs3RLRDdFbDnPkx+HpMf5YcFHHNLb2N3QYMJjQaF0IlazJ6XbdY1v3SeypC61efJgxWIR6YHqJFt9LdNBQIDAQABo1MwUTAdBgNVHQ4EFgQU7q7ziYsTFOWOa7WIfzlJbOp3rXswHwYDVR0jBBgwFoAU7q7ziYsTFOWOa7WIfzlJbOp3rXswDwYDVR0TAQH/BAUwAwEB/zANBgkqhkiG9w0BAQsFAAOCAgEAjosGtOHqaRRmKfIH1/qTpuLMmTpHLnEQpDHiZpjN8z/0mcQXGYhKHQp6AU2d4n8dSrfGoxUzKwRi+HrXCSBKHukEwOh8VZ9CKJzr9YIjHQE5buTSQQDKSrbpgupmEfm7Ujz0Jm1sOdhxE36RR8TuSzzkcI9+YUNYJvUbOxFiamvl4kClwfg7geIVNh04Qt1LfwcS4W63pVaYk7ZUI0FfBv01fXCuXPUaInr25dAZ0cnP20TrzOqk8jihesFU7cXHpzVA2kNc14QtlOMmuStd8cNuPfs1Zykh2kCp0ocJQIsRAVfx9VlDvj6wSA8UlmJh6QJQd5vYPIKHczEhkJkeg+o0hKvO7qQNZ8XYw8+6aTzCQiiyC73f/2Xe8grnaIfX5QGCc/jU7o7Pkdb7Kv80F/oY5perXZcvsZ6mHzQRLADUm8VdIXEqjYBc2+8gGZwvjfRpNrXsi86MTB8BTtwaDqKPJdJdk7xr8mfVf5eP6LcMzXnWf5eZH5Pp0LUzZXjZTogBjucwyw4XN8u8nAFHXb6UFZ+/8/FPtSPdK3O1cIBlXLr0OzNyMrSWh7Ejf4tPuZTrz7hpR8QxdbIZbqKaZ0kMqFIBLsx1o/HjJM3IUiJoeoRouY2sMUwDv0bAcTsd06LdiQHuEh7Ugb7/XQy5lspMCCLxYI+2FXResGD9Dp8="
  },
  "Sources": {
    "build.sh": "./build-image.sh",
    "packages": "/workspace/packages",
    "certs": "/workspace/certs",
    "linuxx64.efi.stub": "/workspace/linuxx64.efi.stub"
  },
  "Steps": {
    "setup-disks": {
      "CreateDisks": [
        {
          "Name": "disk-build",
          "SourceImage": "projects/debian-cloud/global/images/family/debian-11",
          "SizeGb": "200",
          "Type": "pd-ssd"
        }
      ]
    },
    "run-build": {
      "CreateInstances": [
        {
          "Name": "inst-build",
          "Disks": [
            {
              "Source": "disk-build"
            }
          ],
          "MachineType": "e2-highcpu-8",
          "StartupScript": "daisy-build-image.sh",
          "Metadata": {
            "kernel-package": "${kernel_package}",
            "packages": "${packages}"
          },
          "Scopes": [
            "https://www.googleapis.com/auth/devstorage.read_write",
            "https://www.googleapis.com/auth/logging.write"
          ]
        }
      ]
    },
    "wait-for-build": {
      "Timeout": "20m",
      "WaitForInstancesSignal": [
        {
          "Name": "inst-build",
          "SerialOutput": {
            "Port": 1,
            "StatusMatch": "AgileOS build status:",
            "FailureMatch": "Finished running startup scripts.",
            "SuccessMatch": "AgileOS build finished"
          }
        }
      ]
    },
    "delete-build": {
      "DeleteResources": {
        "Instances": [
          "inst-build"
        ]
      }
    },
    "copy-gcs-object": {
      "CopyGCSObjects": [
        {
          "Source": "${OUTSPATH}/disk.tar.gz",
          "Destination": "gs://${image_output_bucket}/v${build_date}/disk.tar.gz"
        }
      ]
    },
    "create-image": {
      "CreateImages": [
        {
          "Name": "agile-os-v${build_date}",
          "RawDisk": {
            "Source": "gs://${image_output_bucket}/v${build_date}/disk.tar.gz"
          },
          "StorageLocations": [
            "us-central1"
          ],
          "GuestOsFeatures": [
            "VIRTIO_SCSI_MULTIQUEUE",
            "UEFI_COMPATIBLE",
            "MULTI_IP_SUBNET"
          ],
          "Family": "agile-os",
          "Project": "${publish_project}",
          "NoCleanup": true,
          "ExactName": true,
          "shieldedInstanceInitialState": {
            "pk": {
              "content": "${pk}",
              "fileType": "X509"
            },
            "keks": [
              {
                "content": "${kek}",
                "fileType": "X509"
              }
            ],
            "dbs": [
              {
                "content": "${db}",
                "fileType": "X509"
              }
            ]
          }
        }
      ]
    }
  },
  "Dependencies": {
    "run-build": [
      "setup-disks"
    ],
    "wait-for-build": [
      "run-build"
    ],
    "delete-build": [
      "wait-for-build"
    ],
    "copy-gcs-object": [
      "wait-for-build"
    ],
    "create-image": [
      "copy-gcs-object"
    ]
  }
}